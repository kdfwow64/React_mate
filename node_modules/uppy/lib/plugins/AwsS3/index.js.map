{"version":3,"sources":["../../../src/plugins/AwsS3/index.js"],"names":["Plugin","require","Translator","XHRUpload","module","exports","core","opts","type","id","title","defaultLocale","strings","preparingUpload","defaultOptions","getUploadParameters","bind","locale","translator","i18n","translate","prepareUpload","file","host","Error","filename","encodeURIComponent","name","fetch","method","headers","accept","then","response","json","fileIDs","forEach","emit","mode","message","value","Promise","all","map","getFile","paramsPromise","resolve","params","catch","error","responses","updatedFiles","index","url","fields","xhrOpts","formData","toLowerCase","endpoint","metaFields","Object","keys","updatedFile","meta","xhrUpload","setState","files","getState","install","addPreProcessor","use","fieldName","responseUrlFieldName","getResponseData","xhr","responseXML","location","responseURL","getValue","key","el","querySelector","textContent","bucket","etag","getResponseError","uninstall","uploader","getPlugin","removePlugin","removePreProcessor"],"mappings":"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","file":"index.js","sourcesContent":["const Plugin = require('../Plugin')\nconst Translator = require('../../core/Translator')\nconst XHRUpload = require('../XHRUpload')\n\nmodule.exports = class AwsS3 extends Plugin {\n  constructor (core, opts) {\n    super(core, opts)\n    this.type = 'uploader'\n    this.id = 'AwsS3'\n    this.title = 'AWS S3'\n\n    const defaultLocale = {\n      strings: {\n        preparingUpload: 'Preparing upload...'\n      }\n    }\n\n    const defaultOptions = {\n      getUploadParameters: this.getUploadParameters.bind(this),\n      locale: defaultLocale\n    }\n\n    this.opts = Object.assign({}, defaultOptions, opts)\n    this.locale = Object.assign({}, defaultLocale, this.opts.locale)\n    this.locale.strings = Object.assign({}, defaultLocale.strings, this.opts.locale.strings)\n\n    this.translator = new Translator({ locale: this.locale })\n    this.i18n = this.translator.translate.bind(this.translator)\n\n    this.prepareUpload = this.prepareUpload.bind(this)\n  }\n\n  getUploadParameters (file) {\n    if (!this.opts.host) {\n      throw new Error('Expected a `host` option containing an uppy-server address.')\n    }\n\n    const filename = encodeURIComponent(file.name)\n    const type = encodeURIComponent(file.type)\n    return fetch(`${this.opts.host}/s3/params?filename=${filename}&type=${type}`, {\n      method: 'get',\n      headers: { accept: 'application/json' }\n    }).then((response) => response.json())\n  }\n\n  prepareUpload (fileIDs) {\n    fileIDs.forEach((id) => {\n      this.core.emit('core:preprocess-progress', id, {\n        mode: 'determinate',\n        message: this.i18n('preparingUpload'),\n        value: 0\n      })\n    })\n\n    return Promise.all(\n      fileIDs.map((id) => {\n        const file = this.core.getFile(id)\n        const paramsPromise = Promise.resolve()\n          .then(() => this.opts.getUploadParameters(file))\n        return paramsPromise.then((params) => {\n          this.core.emit('core:preprocess-progress', file.id, {\n            mode: 'determinate',\n            message: this.i18n('preparingUpload'),\n            value: 1\n          })\n          return params\n        }).catch((error) => {\n          this.core.emit('core:upload-error', file.id, error)\n        })\n      })\n    ).then((responses) => {\n      const updatedFiles = {}\n      fileIDs.forEach((id, index) => {\n        const file = this.core.getFile(id)\n        if (file.error) {\n          return\n        }\n\n        const {\n          method = 'post',\n          url,\n          fields,\n          headers\n        } = responses[index]\n        const xhrOpts = {\n          method,\n          formData: method.toLowerCase() === 'post',\n          endpoint: url,\n          metaFields: Object.keys(fields)\n        }\n\n        if (headers) {\n          xhrOpts.headers = headers\n        }\n\n        const updatedFile = Object.assign({}, file, {\n          meta: Object.assign({}, file.meta, fields),\n          xhrUpload: xhrOpts\n        })\n\n        updatedFiles[id] = updatedFile\n      })\n\n      this.core.setState({\n        files: Object.assign({}, this.core.getState().files, updatedFiles)\n      })\n\n      fileIDs.forEach((id) => {\n        this.core.emit('core:preprocess-complete', id)\n      })\n    })\n  }\n\n  install () {\n    this.core.addPreProcessor(this.prepareUpload)\n\n    this.core.use(XHRUpload, {\n      fieldName: 'file',\n      responseUrlFieldName: 'location',\n      getResponseData (xhr) {\n        // If no response, we've hopefully done a PUT request to the file\n        // in the bucket on its full URL.\n        if (!xhr.responseXML) {\n          return { location: xhr.responseURL }\n        }\n        function getValue (key) {\n          const el = xhr.responseXML.querySelector(key)\n          return el ? el.textContent : ''\n        }\n        return {\n          location: getValue('Location'),\n          bucket: getValue('Bucket'),\n          key: getValue('Key'),\n          etag: getValue('ETag')\n        }\n      },\n      getResponseError (xhr) {\n        // If no response, we don't have a specific error message, use the default.\n        if (!xhr.responseXML) {\n          return\n        }\n        const error = xhr.responseXML.querySelector('Error > Message')\n        return new Error(error.textContent)\n      }\n    })\n  }\n\n  uninstall () {\n    const uploader = this.core.getPlugin('XHRUpload')\n    this.core.removePlugin(uploader)\n\n    this.core.removePreProcessor(this.prepareUpload)\n  }\n}\n"]}